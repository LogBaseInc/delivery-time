function loadCityValues(){if("sampler"==shopifyDs.cakeType)var e={select:"Select city",coimbatore:"Coimbatore"};else var e={select:"Select city",coimbatore:"Coimbatore",trichy:"Trichy"};myCitySelect.find("option").remove(),$.each(e,function(e,t){myCitySelect.append($("<option></option>").val(e).html(t))})}function getIST(){var e=new Date,t=e.getTimezoneOffset(),a=330,i=new Date(e.getTime()+6e4*(a+t));return i}function updateFirstPossibleDeliveryDate(){if(0==lbDatePicker.data.config.defaultDateTimeChecks)return void updateDefaultDeliveryDates();var e=0,t=getIST(),a=t.getDate(),i=t.getHours(),o=lbDatePicker.data.config.workStartTime,r=lbDatePicker.data.config.workingHoursPerDay,s=o+r,l=lbDatePicker.data.config.cakeTypes[shopifyDs.cakeType].prepTime[shopifyDs.cakeVariant],n=s-i;for(0>n&&(n=0);l>n;)l-=n,e++,n=r;1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType&&(e+=1),t.setDate(a+e),delivery.date=t.getDate(),delivery.month=t.getMonth()+1,delivery.year=t.getFullYear(),i>o&&0==e?delivery.hour=i+l+1:delivery.hour=o+l+1,1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType&&(delivery.hour=9)}function checkForHoliday(e){var t=!1;if(0==lbDatePicker.data.config.enableSlotChecks)return!1;if(0==checkForStockAvailability(e))return!0;if($.each(lbDatePicker.data.config.holiday[shopifyDs.city],function(a,i){i.toString().indexOf(e)>=0&&(t=!0)}),1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType){var a=checkForMaxOrders(e);if(a)return!0}return t}function checkForStockAvailability(e){var t=lbDatePicker.data.config.outOfStock[shopifyDs.city];if(null==t||void 0==t)return!0;var a=!0;return $.each(shopifyDs.productTitles,function(i,o){var r=t[o];if(null!=r&&void 0!=r){var s=e.split(" "),l=parseInt(s[0]),n=parseInt(s[1]),c=parseInt(s[2]);s=r.split(" ");var p=parseInt(s[0]),y=parseInt(s[1]),d=parseInt(s[2]);if(!(l>p||n>y&&l==p||c>=d&&n==y&&l==p))return void(a=!1);a=!0}}),a}function checkForMaxOrders(e){var t=0,a=!1,i=0,o=e.split(" ").join(""),r=lbDatePicker.data[shopifyDs.city][o];return null==r||void 0==r?!1:($.each(r,function(e,a){if("11:00"==e||"15:00"==e){var o=parseInt(a);o>=lbDatePicker.data.config.maxSamplersPerSlot&&i++,t+=o}}),(t>=2*lbDatePicker.data.config.maxSamplersPerSlot||i>=2)&&(a=!0),a)}function getDates(){var e={};return $.each(lbDatePicker.dates,function(t,a){var i=t.split(" "),o=i[0],r=i[1],s=i[2];if(!checkForHoliday(t)&&(parseInt(s)>=delivery.date&&parseInt(r)==delivery.month&&parseInt(o)==delivery.year||parseInt(r)>delivery.month&&parseInt(o)==delivery.year||parseInt(o)>delivery.year)){var l=getFreeSlotsForTheDay(s,r,o);l!={}&&(e[t]=a)}}),0==Object.keys(e).length&&deliverySlotsFullNotification(),e}function getFreeSlotsForTheDay(e,t,a){var i={},o=a.toString()+t.toString()+e.toString(),r=lbDatePicker.data.config.maxOrdersPerSlot;return 1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType&&(r=lbDatePicker.data.config.maxSamplersPerSlot),$.each(lbDatePicker.data.config.slots,function(e,t){var a=lbDatePicker.data[shopifyDs.city];if(null!=a&&void 0!=a&&(a=a[o]),null==a||void 0==a)i[e]=t;else{var s=a[e];(null==s||r>s)&&(i[e]=t)}}),i}function getSlots(e){var t=e.split(" "),a=t[0],i=t[1],o=t[2],r=parseInt(o);return lbDatePicker.data.config.enableSlotChecks?slots=getFreeSlotsForTheDay(o,i,a):slots=lbDatePicker.data.config.slots,r==delivery.date?(selectedSlots={},$.each(slots,function(e,t){parseInt(e)>=delivery.hour&&(selectedSlots[e]=t)}),selectedSlots):slots}function updateCakeDs(){$.getJSON("cart.js",function(e){shopifyDs.cartJson=e;var t=[],a=[],i=[];$.each(shopifyDs.cartJson.items,function(e,o){type=o.product_type,void 0!=type&&null!=type&&t.push(type.toLowerCase()),prop=o.properties,null!=prop?(variant=o.properties["Egg/Eggless"],void 0!=variant&&null!=variant?a.push(variant.toLowerCase()):(variant=o.variant_options.toString(),a.push(variant.toLowerCase()))):(variant=o.variant_options.toString(),a.push(variant.toLowerCase())),shopifyDs.productTitles.push(o.product_title.toString()),i.push(o.title.toString().toLowerCase())}),a.toString().indexOf("eggless")>=0?shopifyDs.cakeVariant="eggless":shopifyDs.cakeVariant="egg",t.toString().indexOf("sampler")>=0?shopifyDs.cakeType="sampler":t.toString().indexOf("handcrafted")>=0?shopifyDs.cakeType="handcrafted":t.toString().indexOf("signature")>=0?shopifyDs.cakeType="signature":i.toString().indexOf("2 kg")>=0||i.toString().indexOf("2kg")>=0?shopifyDs.cakeType="xpress2kg":shopifyDs.cakeType="xpress",loadCityValues(),updateFirstPossibleDeliveryDate(),noteToCustomer(),hideDeliverySlotForSampler()})}function hideDeliverySlotForSampler(){var e="";if(1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType&&(e="For <b>Sampler cakes</b> only two delivery slots are available."),"sampler"==shopifyDs.cakeType){var t="<br><b>Sampler Cakes</b> are available only for Coimbatore. Our <b>Sampler Cakes</b> takes a day to deliver. "+e;$("#lbdt-note").html(t)}}function deliverySlotsFullNotification(){var e="";1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType?(e='<br>All delivery slots for <b style="color:#FF0000">Sampler Cakes are full</b>. Please come back tomorrow to order <b>Sampler Cakes</b>. In the mean time you can order our <a href="http://www.cakebee.in/collections/bees-xpress"><b>Xpress Cakes</b></a>.',ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Delivery Slots Full",eventLabel:"Sampler cakes delivery slots full"})):(e='<br>We are sorry, <font style="color:#FF0000">all delivery slots are fully booked for this week!</font> Please check back tomorrow or <a href="http://www.cakebee.in/pages/get-in-touch"> <b>Get in touch</b></a> with us.',ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Delivery Slots Full",eventLabel:"All cakes delivery slots full"})),$("#lbdt-note").html(e)}function noteToCustomer(){if("xpress"!=shopifyDs.cakeType||"egg"!=shopifyDs.cakeVariant){var e=null;e="signature"==shopifyDs.cakeType||"xpress"==shopifyDs.cakeType||"xpress2kg"==shopifyDs.cakeType?"6 hours":"1 day";var t;if(t="xpress"==shopifyDs.cakeType?"Eggless Xpress":"xpress2kg"==shopifyDs.cakeType?"2 kg":shopifyDs.cakeType,"xpress2kg"==shopifyDs.cakeType)var a="<br>Our <b>"+t+" Cakes</b> takes "+e+" to prepare. ";else var a='<br>Our <b><font style="text-transform: capitalize;">'+t+"</font> Cakes</b> takes "+e+" to prepare. ";"xpress"!=shopifyDs.cakeType&&(a+='If you need the cakes to be delivered sooner, please choose our <a href="http://www.cakebee.in/collections/bees-xpress"><b>0.5/1 kg Xpress Cakes</b></a>.'),$("#lbdt-note").html(a),$("#lbdt-note a").click(function(e){ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Cart To Xpress",eventLabel:"Perhaps needed a cake sooner"})})}}function getDefaultDates(){for(var e={Mon:"Monday",Tue:"Tuesday",Wed:"Wednesday",Thu:"Thursday",Fri:"Friday",Sat:"Saturday",Sun:"Sunday"},t=0,a={},i=new Date;7>t;){var o=i.getFullYear().toString()+" "+(i.getMonth()+1).toString()+" "+i.getDate().toString(),r=i.toDateString(),s=r.split(" ")[0];r=r.replace(s,e[s]),r=r.replace(" "+i.getFullYear(),", "+i.getFullYear()),a[o]=r,t++,i.setDate(i.getDate()+1)}lbDatePicker.dates=a}function updateDefaultDeliveryDates(){var e=getIST();if("xpress"==shopifyDs.cakeType){var t=3;if("eggless"==shopifyDs.cakeVariant)var t=7;delivery.date=e.getDate(),delivery.hour=e.getHours()+t,delivery.month=e.getMonth()+1}else"signature"==shopifyDs.cakeType?(delivery.date=e.getDate(),delivery.hour=e.getHours()+7,delivery.month=e.getMonth()+1):(e.setDate(e.getDate()+1),delivery.date=e.getDate(),delivery.hour=e.getHours()+1,delivery.month=e.getMonth()+1)}function getDefaultSlots(){var e={};e["10:00"]="10 - 11 am",e["11:00"]="11 - 12 pm",e["12:00"]="12 - 1 pm",e["13:00"]="1 - 2 pm",e["14:00"]="2 - 3 pm",e["15:00"]="3 - 4 pm",e["16:00"]="4 - 5 pm",e["17:00"]="5 - 6 pm",e["18:00"]="6 - 7 pm",e["19:00"]="7 - 8 pm",e["20:00"]="8 - 9 pm",lbDatePicker.data={},lbDatePicker.data.config={},lbDatePicker.data.config.slots=e,lbDatePicker.data.config.enableSlotChecks=!1,lbDatePicker.data.config.defaultDateTimeChecks=!1}function submitAction(e){if("checkout"!=shopifyDs.submitType)return!0;if(shopifyDs.submitType="update",0!=myDateSelect.val()&&"select"!=myCitySelect.val()&&"select"!=myTimeSelect.val()&&"loading"!=myCitySelect.val()){var t=$("#lbdt-city option:selected").text()+" | "+$("#lbdt-date option:selected").text()+" | "+$("#lbdt-slots option:selected").text();shopifyDs.cartJson.note=t,$.ajax({url:"cart.js",type:"POST",data:shopifyDs.cartJson,async:!1});var a="?city="+shopifyDs.city+"&date="+myDateSelect.val().split(" ").join("")+"&slot="+myTimeSelect.val(),i="/apps/order"+a;$.ajax({url:i,type:"GET",async:!1,timeout:1e3});var o=$("#lbdt-date option:selected").text();return ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Ordered Cake - "+$("#lbdt-city option:selected").text(),eventLabel:o,eventValue:parseInt(myTimeSelect.val())}),ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Slot Selected",eventLabel:$("#lbdt-slots option:selected").text()}),!0}e.preventDefault()}var lbDatePicker={},delivery={date:0,hour:0,month:0,year:0},shopifyDs={cartJson:null,cakeVariant:null,cakeType:null,city:null,submitType:"update",productTitles:[]};if($.ajaxSetup({timeout:1e4}),window.addEventListener("error",function(e){var t=e.colno?" line:"+e.lineno+", column:"+e.colno:" line:"+e.lineno;ga("send","event","JavaScript Error",e.message,e.filename+t+" -> "+navigator.userAgent,0,!0)}),$("#lbdt").length>0){var myDateSelect=$("#lbdt-date"),myTimeSelect=$("#lbdt-slots"),myCitySelect=$("#lbdt-city");$.get("https://microsoft-apiapp54692aa0abc4415dbcbe3f2db1325121.azurewebsites.net/shopify/dates",function(e){lbDatePicker=e,myCitySelect.prop("disabled",!1),updateCakeDs()}).fail(function(){getDefaultDates(),getDefaultSlots(),myCitySelect.prop("disabled",!1),updateCakeDs(),ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Loaded Default Slot Options",eventLabel:"Error while fetching dates from Date Picker"})}),myDateSelect.find("option").remove(),myCitySelect.find("option").remove(),myTimeSelect.find("option").remove(),myCitySelect.append($("<option></option>").val("loading").html("Loading")),myCitySelect.prop("disabled",!0),$("#checkout").click(function(e){shopifyDs.submitType="checkout"}),$("#lbdt-submit").submit(function(e){submitAction(e)}),myCitySelect.change(function(e){if($("#checkout").prop("disabled",!1),myCitySelect.val().toString().indexOf("select")<0){shopifyDs.city=myCitySelect.val(),myDateSelect.find("option").remove();var t={};t[0]="Select date",$.each(getDates(),function(e,a){t[e]=a}),$.each(t,function(e,t){myDateSelect.append($("<option></option>").val(e).html(t))})}else myDateSelect.find("option").remove(),myTimeSelect.find("option").remove()}),myDateSelect.change(function(e){if(myTimeSelect.find("option").remove(),selectedValue=$("#lbdt-date option:selected").text(),selectedValue.indexOf("Select")<0){var t={};if(t.select="Select time slot",1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType){var a=getSlots(myDateSelect.val());null!=a["11:00"]&&(t["11:00"]="10 am - 1 pm"),null!=a["15:00"]&&(t["15:00"]="4 pm - 7 pm")}else $.each(getSlots(myDateSelect.val()),function(e,a){t[e]=a});$.each(t,function(e,t){myTimeSelect.append($("<option></option>").val(e).html(t))})}})}