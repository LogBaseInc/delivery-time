function loadCityValues(){var e={select:"Select city",coimbatore:"Coimbatore",trichy:"Trichy"};myCitySelect.find("option").remove(),$.each(e,function(e,t){myCitySelect.append($("<option></option>").val(e).html(t))})}function getIST(){var e=new Date,t=e.getTimezoneOffset(),a=330,i=new Date(e.getTime()+6e4*(a+t));return i}function updateFirstPossibleDeliveryDate(){if(0==lbDatePicker.data.config.defaultDateTimeChecks)return void updateDefaultDeliveryDates();var e=0,t=getIST(),a=t.getDate(),i=t.getHours(),o=lbDatePicker.data.config.workStartTime,n=lbDatePicker.data.config.workingHoursPerDay,s=o+n,r=lbDatePicker.data.config.cakeTypes[shopifyDs.cakeType].prepTime[shopifyDs.cakeVariant],l=s-i;for(0>l&&(l=0);r>l;)r-=l,e++,l=n;t.setDate(a+e),delivery.date=t.getDate(),delivery.month=t.getMonth()+1,i>o&&0==e?delivery.hour=i+r+1:delivery.hour=o+r+1}function checkForHoliday(e){var t=!1;return 0==lbDatePicker.data.config.enableSlotChecks?!1:($.each(lbDatePicker.data.config.holidays,function(a,i){i.toString().indexOf(e)>=0&&(t=!0)}),t)}function getDates(){var e={};return $.each(lbDatePicker.dates,function(t,a){var i=t.split(" "),o=i[0],n=i[1],s=i[2];if(!checkForHoliday(t)&&(parseInt(s)>=delivery.date&&parseInt(n)==delivery.month||parseInt(n)>delivery.month)){var r=getFreeSlotsForTheDay(s,n,o);r!={}&&(e[t]=a)}}),e}function getFreeSlotsForTheDay(e,t,a){var i={},o=a.toString()+t.toString()+e.toString();return $.each(lbDatePicker.data.config.slots,function(e,t){var a=lbDatePicker.data[shopifyDs.city];if(null!=a&&void 0!=a&&(a=a[o]),null==a||void 0==a)i[e]=t;else{var n=a[e];(null==n||3>n)&&(i[e]=t)}}),i}function getSlots(e){var t=e.split(" "),a=t[0],i=t[1],o=t[2],n=parseInt(o);return lbDatePicker.data.config.enableSlotChecks?slots=getFreeSlotsForTheDay(o,i,a):slots=lbDatePicker.data.config.slots,n==delivery.date?(selectedSlots={},$.each(slots,function(e,t){parseInt(e)>=delivery.hour&&(selectedSlots[e]=t)}),selectedSlots):slots}function updateCakeDs(){$.getJSON("cart.js",function(e){shopifyDs.cartJson=e;var t=[],a=[];$.each(shopifyDs.cartJson.items,function(e,i){type=i.product_type,void 0!=type&&null!=type&&t.push(type.toLowerCase()),prop=i.properties,null!=prop?(variant=i.properties["Egg/Eggless"],void 0!=variant&&null!=variant?a.push(variant.toLowerCase()):(variant=i.variant_options.toString(),a.push(variant.toLowerCase()))):(variant=i.variant_options.toString(),a.push(variant.toLowerCase()))}),a.toString().indexOf("eggless")>=0?shopifyDs.cakeVariant="eggless":shopifyDs.cakeVariant="egg",t.toString().indexOf("sampler")>=0?shopifyDs.cakeType="sampler":t.toString().indexOf("handcrafted")>=0?shopifyDs.cakeType="handcrafted":t.toString().indexOf("signature")>=0?shopifyDs.cakeType="signature":shopifyDs.cakeType="xpress",updateFirstPossibleDeliveryDate(),noteToCustomer(),hideDeliverySlotForSampler()})}function hideDeliverySlotForSampler(){var e="";if(1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType&&(e="For <b>Sampler cakes</b> only two delivery slots are available."),"sampler"==shopifyDs.cakeType){var t="<br>Our <b>Sampler Cakes</b> takes a day to deliver. "+e;$("#lbdt-note").html(t)}}function noteToCustomer(){if("xpress"!=shopifyDs.cakeType||"egg"!=shopifyDs.cakeVariant){var e=null;e="signature"==shopifyDs.cakeType||"xpress"==shopifyDs.cakeType?"6 hours":"1 day";var t;t="xpress"==shopifyDs.cakeType?"Eggless Xpress":shopifyDs.cakeType;var a='<br>Our <b><font style="text-transform: capitalize;">'+t+"</font> Cakes</b> takes "+e+" to prepare. ";"xpress"!=shopifyDs.cakeType&&(a+='If you need the cakes to be delivered sooner, please choose our <a href="http://www.cakebee.in/collections/bees-xpress"><b>Xpress Cakes</b></a>.'),$("#lbdt-note").html(a),$("#lbdt-note a").click(function(e){ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Cart To Xpress",eventLabel:"Perhaps needed a cake sooner"})})}}function getDefaultDates(){for(var e=0,t={},a=new Date;7>e;){var i=a.getFullYear().toString()+" "+(a.getMonth()+1).toString()+" "+a.getDate().toString();t[i]=a.toDateString(),e++,a.setDate(a.getDate()+1)}lbDatePicker.dates=t}function updateDefaultDeliveryDates(){var e=getIST();"xpress"==shopifyDs.cakeType?(delivery.date=e.getDate(),delivery.hour=e.getHours()+3,delivery.month=e.getMonth()+1):"signature"==shopifyDs.cakeType?(delivery.date=e.getDate(),delivery.hour=e.getHours()+7,delivery.month=e.getMonth()+1):(e.setDate(e.getDate()+1),delivery.date=e.getDate(),delivery.hour=e.getHours()+1,delivery.month=e.getMonth()+1)}function getDefaultSlots(){var e={};e["10:00"]="10 - 11 am",e["11:00"]="11 - 12 pm",e["12:00"]="12 - 1 pm",e["13:00"]="1 - 2 pm",e["14:00"]="2 - 3 pm",e["15:00"]="3 - 4 pm",e["16:00"]="4 - 5 pm",e["17:00"]="5 - 6 pm",e["18:00"]="6 - 7 pm",e["19:00"]="7 - 8 pm",e["20:00"]="8 - 9 pm",e["24:00"]="Midnight 11:45 - 12:00",lbDatePicker.data={},lbDatePicker.data.config={},lbDatePicker.data.config.slots=e,lbDatePicker.data.config.enableSlotChecks=!1,lbDatePicker.data.config.defaultDateTimeChecks=!1}function submitAction(e){if("checkout"!=shopifyDs.submitType)return!0;if(shopifyDs.submitType="update",0!=myDateSelect.val()&&"select"!=myCitySelect.val()&&"select"!=myTimeSelect.val()&&"loading"!=myCitySelect.val()){var t=$("#lbdt-city option:selected").text()+" | "+$("#lbdt-date option:selected").text()+" | "+$("#lbdt-slots option:selected").text();shopifyDs.cartJson.note=t,$.ajax({url:"cart.js",type:"POST",data:shopifyDs.cartJson,async:!1});var a="?city="+shopifyDs.city+"&date="+myDateSelect.val().split(" ").join("")+"&slot="+myTimeSelect.val(),i="/apps/order"+a;$.ajax({url:i,type:"GET",async:!1});var o=$("#lbdt-date option:selected").text();return ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Ordered Cake - "+$("#lbdt-city option:selected").text(),eventLabel:o,eventValue:parseInt(myTimeSelect.val())}),ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Slot Selected",eventLabel:$("#lbdt-slots option:selected").text()}),!0}e.preventDefault()}var lbDatePicker={},delivery={date:0,hour:0,month:0},shopifyDs={cartJson:null,cakeVariant:null,cakeType:null,city:null,submitType:"update"};if(window.addEventListener("error",function(e){var t=e.colno?" line:"+e.lineno+", column:"+e.colno:" line:"+e.lineno;ga("send","event","JavaScript Error",e.message,e.filename+t+" -> "+navigator.userAgent,0,!0)}),$("#lbdt").length>0){var myDateSelect=$("#lbdt-date"),myTimeSelect=$("#lbdt-slots"),myCitySelect=$("#lbdt-city");$.get("https://microsoft-apiapp54692aa0abc4415dbcbe3f2db1325121.azurewebsites.net/shopify/dates",function(e){lbDatePicker=e,myCitySelect.prop("disabled",!1),loadCityValues(),updateCakeDs()}).fail(function(){getDefaultDates(),getDefaultSlots(),myCitySelect.prop("disabled",!1),loadCityValues(),updateCakeDs(),ga("send",{hitType:"event",eventCategory:"Date Picker",eventAction:"Loaded Default Slot Options",eventLabel:"Error while fetching dates from Date Picker"})}),myDateSelect.find("option").remove(),myCitySelect.find("option").remove(),myTimeSelect.find("option").remove(),myCitySelect.append($("<option></option>").val("loading").html("Loading")),myCitySelect.prop("disabled",!0),$("#checkout").click(function(e){shopifyDs.submitType="checkout"}),$("#lbdt-submit").submit(function(e){submitAction(e)}),myCitySelect.change(function(e){if($("#checkout").prop("disabled",!1),myCitySelect.val().toString().indexOf("select")<0){shopifyDs.city=myCitySelect.val(),myDateSelect.find("option").remove();var t={};t[0]="Select date",$.each(getDates(),function(e,a){t[e]=a}),$.each(t,function(e,t){myDateSelect.append($("<option></option>").val(e).html(t))})}else myDateSelect.find("option").remove(),myTimeSelect.find("option").remove()}),myDateSelect.change(function(e){if(myTimeSelect.find("option").remove(),selectedValue=$("#lbdt-date option:selected").text(),selectedValue.indexOf("Select")<0){var t={};t.select="Select time slot",1==shopifyDs.cartJson.items.length&&"sampler"==shopifyDs.cakeType?(t["11:00"]="10 am - 1 pm",t["15:00"]="4 pm - 7 pm"):$.each(getSlots(myDateSelect.val()),function(e,a){t[e]=a}),$.each(t,function(e,t){myTimeSelect.append($("<option></option>").val(e).html(t))})}})}